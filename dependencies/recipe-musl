def artifactory_name = "kristianj"
def artifactory_repo = "includeos-develop"
def repo_url = 'https://github.com/hioa-cs/IncludeOS.git'
def repo_branch = 'conan'

def conan_user = 'kristian'
def conan_channel = 'demo'

// binutils
def binutils_version='2.31'
// applies for binutils as in resides in the gnu directory
def recipe_location = 'gnu'

pipeline {
  agent {
    label 'conan_pipe_worker'
  }

  parameters {
    string(name: 'Versions', defaultValue: "v1.1.18", "v1.1.19", "v1.1.20")
    string(name: 'Build_types', defaultValue: "Release", "Debug")
    string(name: 'Architectures', defaultValue: "x86_64", "i686")
  }

  stages {
      stage('Build musl') {
        steps {
          git branch: repo_branch, url: repo_url
          echo "$PATH"
          script {
            def versions = ${params.Versions}
            def architectures = ${params.Architectures}
            def build_types = ${params.Build_types}

            def builds = [:]

            for (ver in versions) {
              for (arch in architectures) {
                for (build in build_types) {
                  String buildName = "${build}-${arch}-${ver}"

                  builds[buildName] = {
                    node('conan_pipe_worker') {
                      stage(buildName) {
                          sh """
                            echo "DEPENDENCY BUILD: creating binutils - (in future download binutils from local conan repo)"
                            conan create conan/${recipe_location}/binutils/${binutils_version} ${conan_user}/${conan_channel}
                            echo "creating musl : ${versions}, build_type = ${build_types}"
                            conan create conan/musl/${versions} ${conan_user}/${conan_channel} --settings build_type=${build_types}
                          """

                      }
                    }
                  }
                }
              }
            }
            parallel builds
          }
        }
      }
  }
}
